# STRP 缓存测试说明

## 概述

这个测试文件用于全面测试 STRP 模板引擎的缓存系统，包括：

- 基础缓存功能
- 缓存键生成机制
- 缓存禁用功能
- 缓存预热
- 性能对比
- 内存管理
- 健康检查
- 错误处理

## 使用方法

### 方法1: 直接运行测试

```lua
-- 导入并运行所有测试
local cache_test = require 'wl.tools.strp.test_cache'
cache_test.main()
```

### 方法2: 使用测试运行器

```lua
-- 运行测试运行器
require 'wl.tools.strp.run_cache_test'
```

### 方法3: 运行单个测试

```lua
local cache_test = require 'wl.tools.strp.test_cache'

-- 只测试基础缓存功能
cache_test.test_basic_cache()

-- 只测试性能对比
cache_test.test_performance_comparison()

-- 获取测试结果
local results = cache_test.get_test_results()
print("通过率:", (results.passed_tests / results.total_tests) * 100, "%")
```

## 测试内容详解

### 1. 基础缓存功能测试

- 验证首次渲染时缓存未命中
- 验证重复渲染时缓存命中
- 检查缓存命中率计算

### 2. 缓存键生成测试

- 验证不同选项生成不同缓存键
- 验证相同选项复用缓存

### 3. 禁用缓存测试

- 验证 `cache = false` 选项生效
- 确认禁用缓存时不创建缓存项

### 4. 缓存预热测试

- 测试批量预热功能
- 验证预热后的缓存命中

### 5. 性能对比测试

- 对比首次渲染、缓存命中、无缓存的性能
- 计算缓存带来的性能提升

### 6. 内存管理测试

- 测试缓存清空功能
- 验证统计信息重置

### 7. 健康检查测试

- 验证健康检查API的完整性
- 检查各模块加载状态

### 8. 错误处理测试

- 确保错误情况下系统稳定性
- 验证错误模板的处理

## 输出示例

```
开始 STRP 缓存系统测试...
==================================================

=== 测试1: 基础缓存功能 ===
✓ 基础缓存-渲染结果: 第一次渲染结果正确
✓ 基础缓存-首次未命中: 第一次渲染应该缓存未命中
✓ 基础缓存-重复渲染结果: 第二次渲染结果正确
✓ 基础缓存-缓存命中: 第二次渲染应该缓存命中
✓ 基础缓存-命中率计算: 缓存命中率应该大于0

=== 测试2: 缓存键生成 ===
✓ 缓存键-选项区分: 不同选项应该生成不同的缓存项
✓ 缓存键-相同选项命中: 相同选项应该命中缓存

...

==================================================
测试完成!
总测试数: 20
通过: 20
失败: 0
成功率: 100.0%
总耗时: 12.34 ms

最终缓存统计:
  缓存大小: 8
  缓存命中: 15
  缓存未命中: 8
  命中率: 65.2%
  内存使用: 1.23 MB

🎉 所有测试通过!
```

## 注意事项

1. **性能测试的准确性**: 由于测试环境的差异，性能测试结果可能会有波动
2. **内存使用**: 测试过程中会创建多个缓存项，正常情况下测试结束后会被清理
3. **错误处理**: 某些错误处理测试可能会在控制台输出错误信息，这是正常现象
4. **模块依赖**: 确保 STRP 主模块及其依赖模块都已正确加载

## 扩展测试

如果需要添加新的测试，请遵循以下模式：

```lua
local function test_new_feature()
    print("\n=== 测试X: 新功能 ===")
    
    -- 准备测试环境
    strp.clear_cache()
    
    -- 执行测试逻辑
    local result = strp.render("test template", {})
    
    -- 验证结果
    assert_test(
        condition,
        "测试描述",
        "测试名称"
    )
end
```

然后在 `run_all_tests()` 函数中添加对新测试函数的调用。
